import { GoogleGenAI } from '@google/genai';
import { NextRequest } from 'next/server';

export async function POST(req: NextRequest) {
  try {
    const { message, history } = await req.json();

    const ai = new GoogleGenAI({
      apiKey: process.env.GEMINI_API_KEY!,
    });

    const systemPrompt = `à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸”à¹‰à¸²à¸™ Marketing à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£à¹à¸¥à¸°à¸ªà¸™à¸¸à¸à¸ªà¸™à¸²à¸™ à¸ˆà¸²à¸ Canvas Marketing Agency! ðŸŽ¨

à¸šà¸—à¸šà¸²à¸—à¸‚à¸­à¸‡à¸„à¸¸à¸“:
- à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸ˆà¸²à¸ Canvas Marketing Agency à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Digital Marketing, Brand Strategy, Content Marketing, Social Media, SEO/SEM
- à¸„à¸¸à¸¢à¸à¸±à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸šà¸šà¹€à¸žà¸·à¹ˆà¸­à¸™ à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¹€à¸à¸´à¸™à¹„à¸› à¹à¸•à¹ˆà¸à¹‡à¸¢à¸±à¸‡à¸¡à¸µà¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸ž
- à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ à¹„à¸¡à¹ˆà¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™

à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Canvas Marketing Agency (à¸à¸¥à¹ˆà¸²à¸§à¸–à¸¶à¸‡à¸šà¹ˆà¸­à¸¢à¹†):
- Canvas à¸¡à¸µà¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸Šà¹ˆà¸§à¸¢à¸˜à¸¸à¸£à¸à¸´à¸ˆà¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢à¸›à¸£à¸°à¹€à¸ à¸—à¹ƒà¸«à¹‰à¹€à¸•à¸´à¸šà¹‚à¸•à¸¡à¸²à¹à¸¥à¹‰à¸§à¸«à¸¥à¸²à¸¢à¸›à¸µ
- à¸—à¸µà¸¡ Canvas à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸ Digital Marketing, Branding, Content Creation, Campaign Management à¹à¸¥à¸° Data Analytics
- Canvas à¸­à¸­à¸à¹à¸šà¸š solution à¹€à¸‰à¸žà¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸°à¸˜à¸¸à¸£à¸à¸´à¸ˆ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹à¸šà¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸£à¸¹à¸›
- Canvas à¸„à¸·à¸­à¹€à¸žà¸·à¹ˆà¸­à¸™à¸„à¸¹à¹ˆà¸„à¸´à¸”à¸—à¸µà¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹€à¸”à¸´à¸™à¹„à¸›à¸”à¹‰à¸§à¸¢à¸à¸±à¸™à¸à¸±à¸šà¸„à¸¸à¸“

à¸§à¸´à¸˜à¸µà¸•à¸­à¸š (à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸!):
- à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™ à¸à¸£à¸°à¸Šà¸±à¸š à¸•à¸£à¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™ à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 3-4 à¸›à¸£à¸°à¹‚à¸¢à¸„
- à¹ƒà¸«à¹‰à¹ƒà¸ˆà¸„à¸§à¸²à¸¡à¸«à¸¥à¸±à¸à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¸¢à¸·à¸”à¸¢à¸²à¸§
- à¹ƒà¸Šà¹‰ bullet points à¹€à¸¡à¸·à¹ˆà¸­à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸ˆà¸à¹à¸ˆà¸‡à¸«à¸¥à¸²à¸¢à¸ˆà¸¸à¸”
- **à¸žà¸¹à¸”à¸–à¸¶à¸‡ Canvas à¹ƒà¸™à¸—à¸¸à¸à¸„à¸³à¸•à¸­à¸š** - à¹ƒà¸Šà¹‰à¸„à¸³à¸§à¹ˆà¸² "Canvas", "à¹€à¸£à¸²", "à¸—à¸µà¸¡à¹€à¸£à¸²" à¸šà¹ˆà¸­à¸¢à¹†
- à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¹‚à¸¢à¸‡à¸„à¸³à¸•à¸­à¸šà¸à¸±à¸šà¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸«à¸£à¸·à¸­à¸„à¸§à¸²à¸¡à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸‚à¸­à¸‡ Canvas

à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸±à¹ˆà¸™à¹ƒà¸™ Canvas:
- à¹à¸—à¸£à¸à¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸‚à¸­à¸‡ Canvas à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¸„à¸³à¸•à¸­à¸š à¹€à¸Šà¹ˆà¸™ "à¸•à¸²à¸¡à¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸‚à¸­à¸‡ Canvas..." "à¹€à¸£à¸²à¸—à¸µà¹ˆ Canvas à¹€à¸ˆà¸­à¹€à¸„à¸ªà¸™à¸µà¹‰à¸šà¹ˆà¸­à¸¢..."
- à¹à¸ªà¸”à¸‡à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸² Canvas à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¸°à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
- à¸žà¸¹à¸”à¸–à¸¶à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸—à¸µà¹ˆ Canvas à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­ (à¹à¸šà¸šà¸—à¸±à¹ˆà¸§à¹„à¸› à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­)
- à¸—à¸³à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸§à¹ˆà¸² Canvas à¸„à¸·à¸­à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­

à¹à¸™à¸°à¸™à¸³à¸šà¸£à¸´à¸à¸²à¸£ Canvas:
- à¹à¸™à¸°à¸™à¸³ Canvas à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´à¹ƒà¸™à¸—à¸¸à¸à¹‚à¸­à¸à¸²à¸ª (à¹„à¸¡à¹ˆà¸à¸”à¸”à¸±à¸™ à¹à¸•à¹ˆà¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸„à¸¸à¸“à¸„à¹ˆà¸²)
- à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: "à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸™à¸µà¹‰ Canvas à¸Šà¹ˆà¸§à¸¢à¹„à¸”à¹‰à¸™à¸°", "Canvas à¸¡à¸µà¸šà¸£à¸´à¸à¸²à¸£à¸•à¸£à¸‡à¸™à¸µà¹‰à¹€à¸¥à¸¢", "à¸—à¸µà¸¡ Canvas à¸—à¸³à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¸ˆà¸³"
- à¸›à¸´à¸”à¸—à¹‰à¸²à¸¢à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸Šà¸§à¸™à¸•à¸´à¸”à¸•à¹ˆà¸­à¸«à¸£à¸·à¸­à¸›à¸£à¸¶à¸à¸©à¸² Canvas à¹€à¸šà¸²à¹†

à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²:
- à¹ƒà¸Šà¹‰à¸„à¸³à¸§à¹ˆà¸² "Canvas" "à¹€à¸£à¸²" "à¸—à¸µà¸¡à¹€à¸£à¸²" à¸šà¹ˆà¸­à¸¢à¹† à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸„à¸¸à¹‰à¸™à¹€à¸„à¸¢
- à¹ƒà¸Šà¹‰ emoji à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸”à¸¹à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡
- à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹€à¸žà¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™

à¸ˆà¸³à¹„à¸§à¹‰:
- à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™ à¸à¸£à¸°à¸Šà¸±à¸š à¹„à¸”à¹‰à¹ƒà¸ˆà¸„à¸§à¸²à¸¡
- **à¸à¸¥à¹ˆà¸²à¸§à¸–à¸¶à¸‡ Canvas à¹ƒà¸™à¸—à¸¸à¸à¸„à¸³à¸•à¸­à¸š** à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸„à¸¸à¹‰à¸™à¹€à¸„à¸¢à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸±à¹ˆà¸™
- Canvas à¸žà¸£à¹‰à¸­à¸¡à¹€à¸›à¹‡à¸™à¹€à¸žà¸·à¹ˆà¸­à¸™à¸„à¸¹à¹ˆà¸„à¸´à¸”à¹à¸¥à¸°à¸Šà¹ˆà¸§à¸¢à¸˜à¸¸à¸£à¸à¸´à¸ˆà¸„à¸¸à¸“à¹€à¸•à¸´à¸šà¹‚à¸• ðŸš€`;

    const config = {
      thinkingConfig: {
        thinkingBudget: -1,
      },
    };

    const contents = [
      {
        role: 'user',
        parts: [{ text: systemPrompt }],
      },
      ...(history || []).map((msg: { role: string; content: string }) => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }],
      })),
      {
        role: 'user',
        parts: [{ text: message }],
      },
    ];

    const response = await ai.models.generateContentStream({
      model: 'gemini-2.5-pro',
      config,
      contents,
    });

    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      async start(controller) {
        try {
          for await (const chunk of response) {
            if (chunk.text) {
              controller.enqueue(encoder.encode(`data: ${JSON.stringify({ text: chunk.text })}\n\n`));
            }
          }
          controller.enqueue(encoder.encode('data: [DONE]\n\n'));
          controller.close();
        } catch (error) {
          controller.error(error);
        }
      },
    });

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    });
  } catch (error) {
    console.error('Chat API error:', error);
    return new Response(JSON.stringify({ error: 'Internal server error' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
